// These tests are racy, and therefore they are run using testSequencedGroup in
// LibExecution.Tests.fs.
//
// We have uploaded files to the cloud storage bucket for the dev-environment canvas
// "test-static-assets-deploy". Tests which fetch/serve need to access these files to
// test, and so will all use the same canvas.
//
// However, we also use deploy hashes for many of these tests. Deploy hashes are
// saved to the DB, and the DB for a particular canvas is cleared between tests.
// Since multiple tests use the same canvas, there is a chance that one test will be
// trying to read the deploy hash while another test is deleting the canvas.
//
// That is, if the tests are running in parallel. We've set them to run using
// testSequenceGroup which eliminates the race. This means we can't use the [tests]
// indicator to create groups, as those tests would be run in parallel.


// baseUrlFor
[test.baseUrlFor] with ExactCanvasName test-baseurlfor-0
StaticAssets.baseUrlFor_v0 "abcdefghi" = "https://test-baseurlfor-0.darksa.com/gd57quywk2db6zncs3h2hxgfdtc/abcdefghi"


// baseUrlForLatest
[test.baseUrlForLatest] with ExactCanvasName test-baseurlforlatest-0, StaticAssetsDeployHash abcdef1234
StaticAssets.baseUrlForLatest_v0 = "https://test-baseurlforlatest-0.darksa.com/hzfhha2hzep63uscg-venrwndxs/abcdef1234"

[tests.baseUrlForLatestWithNoHash]
StaticAssets.baseUrlForLatest_v0 = Test.typeError_v0 "Dark Exception.DarkStorage Err: Expected one result, got none" // OCAMLONLY
StaticAssets.baseUrlForLatest_v0 = Test.typeError_v0 "No deploy hash found" // FSHARPONLY


// urlFor
[test.urlFor] with ExactCanvasName test-urlfor-0
StaticAssets.urlFor_v0 "abcdefghi" "index.html" = "https://test-urlfor-0.darksa.com/3jmuukrzwc2zszlzv_3kxyvd_eo/abcdefghi/index.html"


// urlForLatest
[test.urlForLatest] with ExactCanvasName test-urlforlatest-0, StaticAssetsDeployHash abcdef1234
StaticAssets.urlForLatest_v0 "index.html" = "https://test-urlforlatest-0.darksa.com/bxbyu2t5yencny5j8wus3wszcnc/abcdef1234/index.html"

[tests.urlForLatestWithNoHash]
StaticAssets.urlForLatest_v0 "index.html" = Test.typeError_v0 "Dark Exception.DarkStorage Err: Expected one result, got none" // OCAMLONLY
StaticAssets.urlForLatest_v0 "index.html" = Test.typeError_v0 "No deploy hash found" // FSHARPONLY


// fetch_v0
[test.fetchhtml] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetch_v0 "abcdef1234" "index.html" = Ok "<html><body>Hello world</body></html>\n"

[test.fetch text] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetch_v0 "abcdef1234" "plain.txt" = Ok "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor\nincididunt ut"

[test.fetch png] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetch_v0 "abcdef1234" "favicon-32x32.png" = Error "Response was not\nUTF-8 safe"

[test.fetch missing] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetch_v0 "abcdef1234" "no-file-with-this-name" = Test.typeError "Bad HTTP response (404) in call to https://test-static-assets-deploy.darksa.com/u0n38z-mv-t0tkvnwiqyvankw6w/abcdef1234/no-file-with-this-name"

[test.fetch nohash] with ExactCanvasName test-static-assets-deploy
StaticAssets.fetch_v0 "xx" "index.html" = Test.typeError "Bad HTTP response (404) in call to https://test-static-assets-deploy.darksa.com/u0n38z-mv-t0tkvnwiqyvankw6w/xx/index.html"


// fetch_v1
[test.fetchv1html] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetch_v1 "abcdef1234" "index.html" = Ok "<html><body>Hello world</body></html>\n"

[test.fetchv1text] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetch_v1 "abcdef1234" "plain.txt" = Ok "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor\nincididunt ut"

[test.fetchv1png] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetch_v1 "abcdef1234" "favicon-32x32.png" = Error "Response was not UTF-8 safe"

[test.fetchv1missing] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetch_v1 "abcdef1234" "no-file-with-this-name" = Test.typeError "Bad HTTP response (404) in call to https://test-static-assets-deploy.darksa.com/u0n38z-mv-t0tkvnwiqyvankw6w/abcdef1234/no-file-with-this-name"

[test.fetch nohash] with ExactCanvasName test-static-assets-deploy
StaticAssets.fetch_v1 "xx" "index.html" = Test.typeError "Bad HTTP response (404) in call to https://test-static-assets-deploy.darksa.com/u0n38z-mv-t0tkvnwiqyvankw6w/xx/index.html"


// fetchLatest_v0
[test.fetchLatest_v0 html] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchLatest_v0 "index.html" = Ok "<html><body>Hello world</body></html>\n"

[test.fetchLatest_v0 text] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchLatest_v0 "plain.txt" = Ok "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor\nincididunt ut"

[test.fetchLatest_v0 png] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchLatest_v0 "favicon-32x32.png" = Error "Response was not\nUTF-8 safe"

[test.fetchLatest_v0 missing] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchLatest_v0 "no-file-with-this-name" = Test.typeError "Bad HTTP response (404) in call to https://test-static-assets-deploy.darksa.com/u0n38z-mv-t0tkvnwiqyvankw6w/abcdef1234/no-file-with-this-name"

[test.fetchLatest_v0 nohash OCAMLONLY]
StaticAssets.fetchLatest_v0 "index.html" = Test.typeError "Dark Exception.DarkStorage Err: Expected one result, got none"

[test.fetchLatest_v0 nohash FSHARPONLY]
StaticAssets.fetchLatest_v0 "index.html" = Test.typeError "No deploy hash found"

// fetchLatest_v1
[test.fetchLatest_v1 html] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchLatest_v1 "index.html" = Ok "<html><body>Hello world</body></html>\n"

[test.fetchLatest_v1 text] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchLatest_v1 "plain.txt" = Ok "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor\nincididunt ut"

[test.fetchLatest_v1 png] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchLatest_v1 "favicon-32x32.png" = Error "Response was not\nUTF-8 safe"

[test.fetchLatest_v1 missing] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchLatest_v1 "no-file-with-this-name" = Test.typeError "Bad HTTP response (404) in call to https://test-static-assets-deploy.darksa.com/u0n38z-mv-t0tkvnwiqyvankw6w/abcdef1234/no-file-with-this-name"

[test.fetchLatest_v1 nohash OCAMLONLY]
StaticAssets.fetchLatest_v1 "index.html" = Test.typeError "Dark Exception.DarkStorage Err: Expected one result, got none"

[test.fetchLatest_v1 nohash FSHARPONLY]
StaticAssets.fetchLatest_v1 "index.html" = Test.typeError "No deploy hash found"

// fetchBytes_v0
[test.fetchBytes_v0 html] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchBytes_v0 "abcdef1234" "index.html" = Ok (String.toBytes_v0 "<html><body>Hello world</body></html>\n")

[test.fetchBytes_v0 text] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchBytes_v0 "abcdef1234" "plain.txt" = Ok (String.toBytes_v0 "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor\nincididunt ut")

[test.fetchBytes_v0 png] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchBytes_v0 "abcdef1234" "favicon-32x32.png" = Error "Response was not UTF-8 safe"

[test.fetchBytes_v0 missing] with ExactCanvasName test-static-assets-deploy, StaticAssetsDeployHash abcdef1234
StaticAssets.fetchBytes_v0 "abcdef1234" "no-file-with-this-name" = Test.typeError "Bad HTTP response (404) in call to https://test-static-assets-deploy.darksa.com/u0n38z-mv-t0tkvnwiqyvankw6w/abcdef1234/no-file-with-this-name"

[test.fetchBytes_v0 nohash] with ExactCanvasName test-static-assets-deploy
StaticAssets.fetchBytes_v0 "xx" "index.html" = Test.typeError "Bad HTTP response (404) in call to https://test-static-assets-deploy.darksa.com/u0n38z-mv-t0tkvnwiqyvankw6w/xx/index.html"